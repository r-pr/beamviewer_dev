(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{21:function(e,n,t){e.exports=t(47)},27:function(e,n,t){},46:function(e,n,t){},47:function(e,n,t){"use strict";t.r(n);var o=t(0),a=t.n(o),s=t(19),r=t.n(s),i=t(5),c=t(3),l=t(8),d=t(6),u=t(1),f=t(7),h=(t(27),window.location.host),p="https:"===window.location.protocol?"wss:":"ws:",m={HTTP_SRV_URL:"".concat(window.location.protocol,"//").concat(h),WS_SRV_URL:"".concat(p,"//").concat(h),MAIN_DIV_CLASS:"col-sm-6 col-md-4 col-lg-4 offset-sm-3 offset-md-4 offset-lg-4",DEFAULT_ICE_SERVERS:[{urls:"stun:stun.l.google.com:19302"}]},v=m.MAIN_DIV_CLASS,g=function(e){function n(e,t){var o;return Object(i.a)(this,n),(o=Object(l.a)(this,Object(d.a)(n).call(this,e,t))).onClickPub=o.onClickPub.bind(Object(u.a)(o)),o.onClickSub=o.onClickSub.bind(Object(u.a)(o)),o.onKeyPress=o.onKeyPress.bind(Object(u.a)(o)),o.handleSessIdChange=o.handleSessIdChange.bind(Object(u.a)(o)),o.handleNickNameChnage=o.handleNickNameChnage.bind(Object(u.a)(o)),o.state={sessId:"",nickName:""},o}return Object(f.a)(n,e),Object(c.a)(n,[{key:"render",value:function(){return a.a.createElement(a.a.Fragment,null,a.a.createElement("div",{className:"row"},a.a.createElement("div",{className:v},a.a.createElement("div",{className:"input-group mb-3"},a.a.createElement("input",{type:"text",className:"form-control",placeholder:"Session ID",value:this.state.sessId,onChange:this.handleSessIdChange,onKeyPress:this.onKeyPress,style:{textAlign:"center"}})),a.a.createElement("button",{className:"btn btn-primary btn-block",onClick:this.onClickSub},"Join session"))),a.a.createElement("div",{style:{minHeight:"2em"}}),a.a.createElement("div",{className:"row"},a.a.createElement("div",{className:v},a.a.createElement("button",{className:"btn btn-success btn-block",onClick:this.onClickPub},"Create session"))),a.a.createElement("div",{className:"row",style:{display:this.props.error?"block":"none"}},a.a.createElement("div",{className:v},a.a.createElement("div",{className:"alert alert-danger",role:"alert",style:{marginTop:"1em"}},this.props.error))))}},{key:"handleSessIdChange",value:function(e){this.setState({sessId:e.target.value.trim()})}},{key:"handleNickNameChnage",value:function(e){this.setState({nickName:e.target.value.trim()})}},{key:"onKeyPress",value:function(e){13===((e=e||window.event).keyCode||e.which)&&this.onClickSub(null)}},{key:"onClickPub",value:function(e){this.props.onDecision({mode:"pub"})}},{key:"onClickSub",value:function(e){this.props.onDecision({mode:"sub",nickName:Date.now().toString(),sessionId:this.state.sessId})}}]),n}(a.a.Component),w=t(4),b=t.n(w),y=t(9),k=t(20),E=t.n(k);function S(e){return new Promise(function(n){setTimeout(n,e)})}var O=function(){function e(n){Object(i.a)(this,e),this.onCandidate=void 0,this.onOffer=void 0,this.onAnswer=void 0,this.url=void 0,this.ws=void 0,this.pendingPromise=void 0,this.sessId=void 0,this.previousReconnectTime=void 0,this.url=n,this.ws=null,this.pendingPromise={},this.sessId="",this.previousReconnectTime=0}return Object(c.a)(e,null,[{key:"getIceServers",value:function(){var e=Object(y.a)(b.a.mark(function e(){var n,t;return b.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n="".concat(m.HTTP_SRV_URL,"/ice_servers"),e.next=3,E.a.get(n);case 3:if(200===(t=e.sent).status&&t.data&&t.data.iceServers){e.next=7;break}return console.warn("default ice servers"),e.abrupt("return",m.DEFAULT_ICE_SERVERS);case 7:return e.abrupt("return",t.data.iceServers);case 8:case"end":return e.stop()}},e)}));return function(){return e.apply(this,arguments)}}()}]),Object(c.a)(e,[{key:"getSessId",value:function(){return this.sessId}},{key:"connect",value:function(){var e=this;return new Promise(function(n,t){try{console.log("try construct websocket"),e.ws=new WebSocket(e.url),console.log("ws constructed")}catch(o){return console.log("ws construct:: err"),t(o),e.reconnect()}e.ws.onopen=n,e.ws.onerror=function(e){console.warn("ws::on_error::"+e)},e.ws.onmessage=e.onMessage.bind(e),e.ws.onclose=function(){e.ws.onerror=null,e.ws.onmessage=null,console.log("ws closed, gonna reconnect"),Date.now()-e.previousReconnectTime<2e3?(console.log("wait 2000 msec before reconnect"),setTimeout(e.reconnect.bind(e),2e3)):e.reconnect()}})}},{key:"logIn",value:function(e){var n=this;return new Promise(function(t,o){n.pendingPromise={resolve:t,reject:o},e?console.log("login, sessId=".concat(e," (").concat(typeof e,")")):(e=function(){var e=new Uint8Array(3),n=[];return window.crypto.getRandomValues(e),e.forEach(function(e){return n.push(e.toString(16))}),n.join("")}(),n.sessId=e),n.send({type:"login",sess_id:e})})}},{key:"join",value:function(e,n){var t=this;return new Promise(function(o,a){t.pendingPromise={resolve:o,reject:a},t.send({type:"join",sess_id:e,nickname:n})})}},{key:"send",value:function(e){this.ws.send(JSON.stringify(e))}},{key:"onMessage",value:function(e){var n={};try{n=JSON.parse(e.data)}catch(t){return void console.warn("ws: "+t.message+". msg.data="+e.data)}switch(console.log("ws: ",n),n.type){case"login_resp":this.handleLoginResp(n);break;case"candidate":this.handleCandidate(n);break;case"offer":this.handleOffer(n);break;case"answer":this.handleAnswer(n);break;case"join_resp":this.handleJoinResp(n)}}},{key:"handleLoginResp",value:function(e){"ok"===e.status?this.pendingPromise.resolve(this.sessId):this.pendingPromise.reject(new Error(e.error)),this.pendingPromise={}}},{key:"handleJoinResp",value:function(e){"ok"===e.status?this.pendingPromise.resolve():this.pendingPromise.reject(new Error(e.error)),this.pendingPromise={}}},{key:"handleCandidate",value:function(e){console.log(Date.now()+" ws: got candidate"),this.onCandidate&&"function"===typeof this.onCandidate&&this.onCandidate(e.candidate)}},{key:"handleOffer",value:function(e){console.log(Date.now()+" ws: got offer"),e.offer?this.onOffer&&"function"===typeof this.onOffer&&this.onOffer(e.offer):console.warn(".offer is "+e.offer)}},{key:"handleAnswer",value:function(e){console.log(Date.now()+" ws: got answer"),this.onAnswer&&"function"===typeof this.onAnswer&&this.onAnswer(e.answer)}},{key:"reconnect",value:function(){var e=this;this.previousReconnectTime=Date.now(),this.ws=null;var n=1;Object(y.a)(b.a.mark(function t(){return b.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=1,console.log("try reconnect"),t.next=5,e.connect();case 5:return t.abrupt("break",17);case 8:return t.prev=8,t.t0=t.catch(1),console.warn(t.t0),n<10&&n++,console.log("reconnect failed, now sleeping ".concat(n," sec")),t.next=15,S(1e3*n);case 15:t.next=0;break;case 17:if(console.log("reconnected"),!e.sessId){t.next=23;break}return console.log("was logged in before, logging after reconnect"),t.next=22,e.logIn(e.sessId);case 22:console.log("login after reconnect: ok");case 23:case"end":return t.stop()}},t,null,[[1,8]])}))()}}]),e}(),C=function(){return a.a.createElement("div",{className:"d-flex justify-content-center"},a.a.createElement("div",{className:"spinner-border",style:{width:"3rem",height:"3rem"},role:"status"},a.a.createElement("span",{className:"sr-only"},"Loading...")))},j=function(){function e(){Object(i.a)(this,e)}return Object(c.a)(e,[{key:"getDisplayMedia",value:function(e){if(!this.canGetDisplayMedia())throw new Error("old browser");return e||(e={audio:!1,video:{cursor:"never"}}),navigator.mediaDevices.getDisplayMedia(e)}},{key:"canGetDisplayMedia",value:function(){return navigator.mediaDevices&&!!navigator.mediaDevices.getDisplayMedia}}]),e}(),I=m.MAIN_DIV_CLASS,x={},R=null,N=[],D=!1,P=function(e){function n(e){var t;return Object(i.a)(this,n),(t=Object(l.a)(this,Object(d.a)(n).call(this,e))).videoRef=void 0,t.userMedia=void 0,t.state={sessId:"",error:"",loading:!0},t.videoRef=a.a.createRef(),t.userMedia=new j,t.copySessIdToClipboard=t.copySessIdToClipboard.bind(Object(u.a)(t)),t}return Object(f.a)(n,e),Object(c.a)(n,[{key:"componentDidMount",value:function(){var e=this;this.userMedia.canGetDisplayMedia()?Object(y.a)(b.a.mark(function n(){var t,o,a,s,r,i,c;return b.a.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,t=new O(m.WS_SRV_URL),n.next=4,O.getIceServers();case 4:return o=n.sent,a=function(e){N=[],(R=new RTCPeerConnection({iceServers:o})).addStream(i),R.onicecandidate=function(e){console.log("on ice"),e.candidate?D?(t.send({type:"candidate",candidate:e.candidate}),console.log("candidate sent")):(console.log("candidate buffered"),N.push(e.candidate)):(console.log("no event.candidate::"),console.log(e))}},s=function(e){t.send({type:"offer",offer:e}),D=!0,N.length&&N.forEach(function(e){t.send({type:"candidate",candidate:e})})},console.log("gona connect"),n.next=10,t.connect();case 10:return console.log("connected"),n.next=13,t.logIn();case 13:return r=t.getSessId(),console.log("logged in with sess_id="+r),n.next=17,e.userMedia.getDisplayMedia();case 17:return i=n.sent,e.videoRef.current&&(e.videoRef.current.srcObject=i),a(i),n.next=22,R.createOffer();case 22:c=n.sent,console.log("offer created"),R.setLocalDescription(c),t.onAnswer=function(e){R.onicecandidate=function(){},R.setRemoteDescription(new RTCSessionDescription(e)),console.log("got answer"),x[e.nickname]=R,Object(y.a)(b.a.mark(function e(){var n;return b.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("creating new tmp connection..."),a(i),e.next=4,R.createOffer();case 4:n=e.sent,console.log("new offer created"),R.setLocalDescription(n),s(n);case 8:case"end":return e.stop()}},e)}))()},s(c),e.setState({sessId:r,loading:!1}),n.next=34;break;case 30:n.prev=30,n.t0=n.catch(0),console.error(n.t0),e.setState({error:n.t0.message});case 34:case"end":return n.stop()}},n,null,[[0,30]])}))():this.setState({error:"you have an old browser, go get a newer one"})}},{key:"render",value:function(){return a.a.createElement("div",{className:"row"},a.a.createElement("div",{className:I},a.a.createElement("video",{ref:this.videoRef,autoPlay:!0,style:{width:"100%",display:this.state.loading?"none":"block",border:"1px solid darkgray",borderRadius:"0.5em"}}),this.getActiveElement()))}},{key:"copySessIdToClipboard",value:function(){navigator.clipboard&&navigator.clipboard.writeText&&navigator.clipboard.writeText(this.state.sessId)}},{key:"getActiveElement",value:function(){return this.state.error?a.a.createElement("div",{className:"alert alert-danger",role:"alert"},this.state.error):this.state.loading?a.a.createElement(C,null):a.a.createElement(a.a.Fragment,null,a.a.createElement("h5",{style:{marginTop:"2em"}},"Session ID:  ",a.a.createElement("b",null,this.state.sessId),"\xa0\xa0",a.a.createElement("button",{className:"btn btn-secondary btn-sm",onClick:this.copySessIdToClipboard},"Copy")))}}]),n}(a.a.Component);function _(e){switch(e){case"ENOTFOUND":return"Session with given ID not found";default:return e}}var M=function(e){function n(e){var t;return Object(i.a)(this,n),(t=Object(l.a)(this,Object(d.a)(n).call(this,e))).videoRef=void 0,t.state={error:""},t.videoRef=a.a.createRef(),t.exitOk=t.exitOk.bind(Object(u.a)(t)),t}return Object(f.a)(n,e),Object(c.a)(n,[{key:"componentDidMount",value:function(){var e=this,n=this.props.nickName,t=new O(m.WS_SRV_URL);Object(y.a)(b.a.mark(function o(){var a,s;return b.a.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return console.log("sub: gona connect"),o.next=3,t.connect();case 3:return console.log("sub: connected"),o.next=6,O.getIceServers();case 6:return a=o.sent,(s=new RTCPeerConnection({iceServers:a})).ontrack=function(n){if(!e.videoRef.current)throw new Error("sth went wrong");e.videoRef.current.srcObject=n.streams[0],e.videoRef.current.style.position="absolute",e.videoRef.current.style.top="0px",e.videoRef.current.style.left="0px"},s.onicecandidate=function(e){console.log("on ice"),e.candidate&&t.send({type:"candidate",candidate:e.candidate,nickname:n})},t.onOffer=function(e){console.log("sub:: onoffer: ",e);try{s.setRemoteDescription(new RTCSessionDescription(e)),s.createAnswer().then(function(e){s.setLocalDescription(e),t.send({type:"answer",answer:e,nickname:n})},function(e){console.error(e)})}catch(o){console.error(o)}},t.onCandidate=function(e){s.addIceCandidate(new RTCIceCandidate(e))},o.prev=12,o.next=15,t.join(e.props.sessId,n);case 15:o.next=21;break;case 17:o.prev=17,o.t0=o.catch(12),console.warn(o.t0),e.props.onExit(new Error(_(o.t0.message)));case 21:case"end":return o.stop()}},o,null,[[12,17]])}))()}},{key:"render",value:function(){return a.a.createElement("div",{className:"row"},a.a.createElement("div",{className:"col-xs-12"},a.a.createElement("video",{ref:this.videoRef,autoPlay:!0,style:{width:"100%"}}),a.a.createElement("div",{style:{background:"rgba(0, 255, 0, .5)",width:50,height:50,position:"absolute",top:0,right:0,zIndex:2,textAlign:"center",fontSize:"2em",cursor:"pointer"},onClick:this.exitOk},"X")))}},{key:"exitOk",value:function(){this.props.onExit()}}]),n}(a.a.Component),T=function(e){function n(e,t){var o;return Object(i.a)(this,n),(o=Object(l.a)(this,Object(d.a)(n).call(this,e,t))).state={error:""},o.onUserDecision=o.onUserDecision.bind(Object(u.a)(o)),o.onExit=o.onExit.bind(Object(u.a)(o)),o}return Object(f.a)(n,e),Object(c.a)(n,[{key:"render",value:function(){return a.a.createElement("div",{className:"container-fluid"},a.a.createElement("div",{className:"row"},a.a.createElement("h1",{className:"col-sm-12 App-header2",style:{textAlign:"center"}},"BeamViewer")),this.getActiveComponent())}},{key:"onExit",value:function(e){e?this.setState({appMode:void 0,error:e.message}):this.setState({appMode:void 0})}},{key:"onUserDecision",value:function(e){this.setState({appMode:e})}},{key:"getActiveComponent",value:function(){if(this.state.appMode){if("pub"===this.state.appMode.mode)return a.a.createElement(P,null);if("sub"===this.state.appMode.mode)return a.a.createElement(M,{nickName:this.state.appMode.nickName,sessId:this.state.appMode.sessionId,onExit:this.onExit});throw new Error}return a.a.createElement(g,{onDecision:this.onUserDecision,error:this.state.error})}}]),n}(a.a.Component);t(46),Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));"http:"===window.location.protocol&&"localhost"!==window.location.hostname&&(console.log("redirect to https"),window.location.replace(window.location.href.replace("http:","https:"))),r.a.render(a.a.createElement(T,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(function(e){e.unregister()})}},[[21,1,2]]]);
//# sourceMappingURL=main.dd0c631b.chunk.js.map