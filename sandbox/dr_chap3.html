<!DOCTYPE html>
<html>

<head>
    <style>
    #video {
        border: 1px solid #999;
        width: 98%;
        max-width: 860px;
    }

    .error {
        color: red;
    }

    .warn {
        color: orange;
    }

    .info {
        color: darkgreen;
    }
    </style>
    <meta charset="utf-8" />
    <title>Learning WebRTC - Chapter 3: Creating a RTCPeerConnection</title>
</head>

<body>
    <div id="container">
        <video id="yours" autoplay></video>
        <video id="theirs" autoplay></video>
    </div>
</body>
<script>

const oldConsoleLog = console.log;
console.log = (a, b, c) => {
    oldConsoleLog(Date.now(), a, b || '', c || '');
}

function hasUserMedia() {
    navigator.getUserMedia = navigator.getUserMedia ||
        navigator.webkitGetUserMedia || navigator.mozGetUserMedia ||
        navigator.msGetUserMedia;
    return !!navigator.getUserMedia;
}

function hasRTCPeerConnection() {
    window.RTCPeerConnection = window.RTCPeerConnection ||
        window.webkitRTCPeerConnection || window.mozRTCPeerConnection;
    return !!window.RTCPeerConnection;
}

function startPeerConnection(stream) {
    var configuration = {
        // Uncomment this code to add custom iceServers
        //"iceServers": [{ "url": "stun:stun.1.google.com:19302" }]"
    };
    yourConnection = new RTCPeerConnection(configuration);
    theirConnection = new RTCPeerConnection(configuration);

    // Setup ice handling
    yourConnection.onicecandidate = function(event) {
        console.log("yourConn.onicecandidate()")
        if (event.candidate) {
            console.log("yourConn.addIceCandidate()")
            theirConnection.addIceCandidate(new RTCIceCandidate(event.candidate));
        }
    };

    theirConnection.onicecandidate = function(event) {
        console.log("theirConn.onicecandidate()")
        if (event.candidate) {
            console.log("theirConn.addIceCandidate()")
            yourConnection.addIceCandidate(new RTCIceCandidate(event.candidate));
        }
    };


    theirConnection.ontrack = function(event) {
        console.log("theirConn.ontrack()")
        theirVideo.srcObject = event.streams[0];
    };

    // Setup stream listening
    yourConnection.addStream(stream);

    // Begin the offer
    yourConnection.createOffer({}).then((offer) => {
        console.log('offer created');
        yourConnection
            .setLocalDescription(offer)
            .then(
                () => {console.log('yourCon.SLD: ok')},
                () => {console.log('yourCon.SLD: fail')}
            );
        theirConnection
            .setRemoteDescription(offer)
            .then(
                () => {console.log('theirCon.SRD: ok')},
                () => {console.log('theirCon.SRD: fail')}
            );
        theirConnection.createAnswer().then((offer2) => {
            console.log('answer created');
            theirConnection
                .setLocalDescription(offer2)
                .then(
                () => {console.log('theirCon.SLD: ok')},
                () => {console.log('theirCon.SLD: fail')}
            );
            yourConnection
                .setRemoteDescription(offer2)
                .then(
                    () => {console.log('yourCon.SRD: ok')},
                    () => {console.log('yourCon.SRD: fail')}
                );
        }, (err) => {
            console.log('theirCon.createAnsw():', err)
        });
    }, (error) => {
        console.warn('create offer: ', error);
    })
}

var yourVideo = document.querySelector('#yours'),
    theirVideo = document.querySelector('#theirs'),
    yourConnection, theirConnection;

if (hasUserMedia()) {
    navigator.getUserMedia({ video: true, audio: false }, function(stream) {
        yourVideo.srcObject = stream;
        if (hasRTCPeerConnection()) {
            startPeerConnection(stream);
        } else {
            alert("Sorry, your browser does not support WebRTC (no RTCPeerConnection)");
        }
    }, function(error) {
        alert("Sorry, we failed to capture your camera, please try again.");
    });
} else {
    alert("Sorry, your browser does not support WebRTC. (no getUserMedia())");
}
</script>

</html>